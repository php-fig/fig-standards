Метадокумент PSR-4
================

1. Обзор
--------

Цель — определить правила для взаимозаменяемого автозагрузчика для PHP, который
ставит в соответствие пространства имён и пути в файловой системе, и может сосуществовать с любым другим
зарегистрированным через SPL автозагрузчиком. Правила должны быть не заменой PSR-0, а дополнением к нему.

2. Зачем всё это?
-----------------

### История PSR-0

Стандарт именования классов и автозагрузки PSR-0 появился под влиянием широкого использования
соглашений Horde/PEAR и ограничений, накладываемых PHP версии 5.2 и старше. Согласно этим
соглашениям, все классы размещались в одной главной директории и использовали символы подчёркивания
в имени для псевдопространств имён:

    /path/to/src/
        VendorFoo/
            Bar/
                Baz.php     # VendorFoo_Bar_Baz
        VendorDib/
            Zim/
                Gir.php     # Vendor_Dib_Zim_Gir

Вышел PHP 5.3 с полноценными пространствами имён. PSR-0 всё ещё
позволял как старое именование с подчёркиваниями в стиле Horde/PEAR, *так и*
использование настоящих пространств имён. Для более плавного перехода
к новому именованию символы подчёркивания всё ещё разрешалось
использовать в имени класса. Это было необходимо для более широкого распространения.

    /path/to/src/
        VendorFoo/
            Bar/
                Baz.php     # VendorFoo_Bar_Baz
        VendorDib/
            Zim/
                Gir.php     # VendorDib_Zim_Gir
        Irk_Operation/
            Impending_Doom/
                V1.php
                V2.php      # Irk_Operation\Impending_Doom\V2

Данная структура создавалась под воздействием того факта, что PEAR копировал исходные файлы из пакетов в одну
центральную директорию.

### И тут появился Composer

С приходом Composer исходные файлы пакетов перестали копироваться в единственную глобальную директорию. Вместо этого
они используются оттуда, куда были установлены. Это означает, что в случае Composer какой-либо «главной директории» для
PHP кода, как это было в случае PEAR, нет. Вместо этого имеются несколько директорий. Каждый пакет находится в отдельной
директории для каждого проекта.

Чтобы при этом соответствовать PSR-0, пакет Composer выглядит вот так:

    vendor/
        vendor_name/
            package_name/
                src/
                    Vendor_Name/
                        Package_Name/
                            ClassName.php       # Vendor_Name\Package_Name\ClassName
                tests/
                    Vendor_Name/
                        Package_Name/
                            ClassNameTest.php   # Vendor_Name\Package_Name\ClassNameTest

Директории «src» и «tests» обязаны включать в себя директории с именем производителя и именем пакета, что является
следствием соблюдения PSR-0.

Многие находят данную структуру излишне вложенной и включающей слишком много повторений и предлагают разработать
новый PSR или дополнить существующий таким образом, чтобы пакеты выглядили примерно так:

    vendor/
        vendor_name/
            package_name/
                src/
                    ClassName.php       # Vendor_Name\Package_Name\ClassName
                tests/
                    ClassNameTest.php   # Vendor_Name\Package_Name\ClassNameTest

Это потребовало бы реализации того, что изначально называлось «пакетно-ориентированная автозагрузка» (в противовес
традиционной «загрузке с преобразованием класса в имя файла»).

### Пакетно-ориентированная автозагрузка

Довольно сложно реализовать пакетно-ориентированную автозагрузку в виде расширения
или дополнения к PSR-0, потому как PSR-0 не допускает пересечений путей для любых частях
имени класса. То есть реализация пакетно-ориентированного автозагрузчика была бы
более сложной, чем PSR-0. Тем не менее, она позволила бы использовать более простую
структуру пакетов.

Изначально были предложены следующие правила:

1. Реализации ДОЛЖНЫ использовать как минимум два уровня в пространстве имён: имя производителя и
название пакета этого производителя. (Эта комбинация из двух имён верхнего уровня далее называется
имя производителя-пакета или пространство имён производителя-пакета.)

2. Реализации ДОЛЖНЫ позволять использовать путь между именем производителя-пакета и оставшейся
частью абсолютного имени класса.

3. Имя производителя-пакета МОЖЕТ соответствовать любой директории. Оставшаяся часть абсолютного
имени класса ДОЛЖНА сопоставлять пространства имён одноимённым директориям. Имя класса ДОЛЖНО
соответствовать одноимённому файлу, заканчивающемуся на «.php».

Стоит отметить, что это отменяет использование подчёркивания в качестве
разделителя директории в имени класса. Можно подумать, что подчёркивания
должны остаться в соответствии с PSR-0, но так как их использование изначально
было введено для перехода с PHP 5.2 и псевдопространств имён, допустимо убрать
их на этом этапе.


3. Рамки
--------

### 3.1 Цели

- Сохранить правило PSR-0, гласящее о том, что реализации ДОЛЖНЫ использовать как минимум
  два уровня пространства имён: имя производителя и имя пакета этого производителя.

- Позволить использовать путь между именем производителя-пакета и остатком абсолютного
  имени класса.

- Сделать так, чтобы имя производителя-пакета МОГЛО соответствовать любой директории и, возможно,
  нескольким директориям.

- Отменить использование символов подчёркивания в качестве разделителей директорий в именах классов.

### 3.2 Не цели

- Предоставить общий алгоритм преобразования для ресурсов, не являющихся классами


4. Подходы
----------

### 4.1 Выбранный подход

Данный подход сохраняет ключевые характеристики PSR-0, при этом устраняя вложенность
директорий, которую он требует. Кроме того, он задаёт дополнительные правила,
которые позволяют реализациям быть в большей степени взаимозаменяемыми.

Несмотря на то, что это не относится к соответствию директорий, финальный черновик также
определяет, как автозагрузчики должны работать с ошибками.  А именно, запрещает выкидывать
исключения и вызывать ошибки. На это есть две причины:

1. Автозагрузчики в PHP изначально разработаны, чтобы использоваться вместе. То есть если один
загрузчик не может загрузить класс, другой имеет все шансы на успех. Автозагрузчик, который
вызывает ошибку, нарушает эту совместимость.

2. Для `class_exists()` и `interface_exists()` «не найдено даже после попытки автозагрузки» — нормальная
ситуация. Автозагрузчик, выкидывающий исключения, делает `class_exists()` непригодным для использования,
что совершенно недопустимо с точки зрения взаимозаменяемости. Автозагрузчики, которые хотят предоставить
дополнительную отладочную информацию в случае ненайденного класса, должны делать это при помощи логирования
как при помощи совместимой с PSR-3 библиотеки, так и любым другим способом.

Плюсы:

- меньше вложенность директорий;
- более гибкое расположение файлов;
- подчёркивания в имени класса больше не используются как разделитель директорий;
- реализации становятся заметно более взаимозаменяемыми.

Минусы:

- невозможно, как в случае PSR-0, однозначно определить положение класса в файловой системе по его имени
  (то есть отсутствует соглашение о сопоставлении «класс-файл» из Horde/PEAR).


### 4.2 Альтернатива: оставить только PSR-0

Использование только PSR-0 хоть и логично, но оставляет нас с более вложенными директориями.

Плюсы:

- не нужно менять привычки и реализации.

Минусы:

- всё та же большая вложенность директорий;
- подчёркивания в имени класса используются как разделитель директорий.


### 4.3 Альтернатива: разделить автозагрузку и преобразование

Beau Simensen и другие предложили выделить алгоритм преобразования из стандарта
автозагрузки в отдельный стандарт, на который можно было бы ссылаться.
После проведения начальной работы по их разделению, последовавшего голосования и
обсуждения, предпочтение было отдано комбинированной версии (т. е. правила
преобразования остались в том же стандарте).

Плюсы:

- на правила преобразования можно ссылаться из других стандартов.

Минусы:

- не соответствует результатам опроса и пожеланиям некоторых авторов.

### 4.4 Альтернатива: использование более простого и понятного языка

После того, как второе голосование было отозвано спонсором ввиду того, что
голосовавшие хоть и отвечали +1, поддерживая идею, но не соглашались с формулировками
в тексте (или не понимали их), наступил период, в который язык текста был сделан
более простым и понятным. У данного подхода всё ещё были противники. Спустя некоторое время
Beau Simensen составил пробную версию в стиле PSR-0, которую за её лаконичность поддержали
редактор и спонсоры. Далее она была доработана Paul M. Jones и многими другими.

### Замечание о совместимости с PHP 5.3.2 и ниже

Версии PHP до 5.3.3 не удаляли завершающий разделитель пространства имён, поэтому это должна делать реализация.
Если этого не сделать, поведение автозагрузчика может быть непредсказуемым.


5. Авторы
---------

### 5.1 Редактор

- Paul M. Jones, Solar/Aura

### 5.2 Спонсоры

- Phil Sturgeon, PyroCMS (координатор)
- Larry Garfield, Drupal

### 5.3 Помощники

- Andreas Hennings
- Bernhard Schussek
- Beau Simensen
- Donald Gilbert 
- Mike van Riel
- Paul Dragoonis
- Всех не перечислить, не пересчитать


6. Голосование
--------------

- **Начальное:** <https://groups.google.com/d/msg/php-fig/_LYBgfcEoFE/ZwFTvVTIl4AJ>

- **Финальное:**

    - Первая попытка: <https://groups.google.com/forum/#!topic/php-fig/Ua46E344_Ls>,
      предпринята до введения новых процедур голосования. Отменена из-за того, что текст случайно поменяли.
      
    - Вторая попытка: <https://groups.google.com/forum/#!topic/php-fig/NWfyAeF7Psk>,
      отменена по инициативе спонсора <https://groups.google.com/forum/#!topic/php-fig/t4mW2TQF7iE>
    
    - Третья попытка: TBD


7. Ссылки
---------

- [Autoloader, round 4](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/lpmJcmkNYjM)
- [POLL: Autoloader: Split or Combined?](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/fGwA6XHlYhI)
- [PSR-X autoloader spec: Loopholes, ambiguities](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/kUbzJAbHxmg)
- [Autoloader: Combine Proposals?](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/422dFBGs1Yc)
- [Package-Oriented Autoloader, Round 2](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/Y4xc71Q3YEQ)
- [Autoloader: looking again at namespace](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/bnoiTxE8L28)
- [DISCUSSION: Package-Oriented Autoloader - vote against](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/SJTL1ec46II)
- [VOTE: Package-Oriented Autoloader](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/Ua46E344_Ls)
- [Proposal: Package-Oriented Autoloader](https://groups.google.com/forum/#!topicsearchin/php-fig/autoload/php-fig/qT7mEy0RIuI)
- [Towards a Package Oriented Autoloader](https://groups.google.com/forum/#!searchin/php-fig/package$20oriented$20autoloader/php-fig/JdR-g8ZxKa8/jJr80ard-ekJ)
- [List of Alternative PSR-4 Proposals](https://groups.google.com/forum/#!topic/php-fig/oXr-2TU1lQY)
- [Summary of [post-Acceptance Vote pull] PSR-4 discussions](https://groups.google.com/forum/#!searchin/php-fig/psr-4$20summary/php-fig/bSTwUX58NhE/YPcFgBjwvpEJ)
